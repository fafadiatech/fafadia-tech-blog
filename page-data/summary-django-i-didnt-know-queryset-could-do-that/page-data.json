{"componentChunkName":"component---src-templates-index-js","path":"/summary-django-i-didnt-know-queryset-could-do-that/","result":{"data":{"site":{"meta":{"title":"Fafadia Tech Blog","description":"Official Blog of Fafadia Tech","url":"http://www.fafadiatech.com","author":"fafadiatech","twitter":"fafadiatechhq``","adsense":""}},"post":{"id":"ac39f3c8-b8e5-53ae-b851-03c3e0490137","html":"<p><a href=\"https://docs.djangoproject.com/en/1.11/ref/models/querysets/\">Queryset</a> are commonly used with Django’s ORM. <a href=\"https://www.youtube.com/watch?v=5y7vU52jOiQ\">I Didn’t Know Querysets Could do That by Charlie Guo</a> is a nice Django Con US 2016 talk that delves deeper into useage of QuerySet.</p>\n<p>Following is summary notes of the talk</p>\n<h2>Basic Queryset method</h2>\n<ul>\n<li>\n<p>Methods that return QuerySet</p>\n<ul>\n<li>all</li>\n<li>filter</li>\n<li>exclude</li>\n<li>oder_by</li>\n<li>reverse</li>\n<li>distinct</li>\n<li>annotate</li>\n</ul>\n</li>\n<li>\n<p>Methods that return model instance</p>\n<ul>\n<li>get</li>\n<li>first</li>\n<li>last</li>\n<li>latest</li>\n<li>earliest</li>\n<li>exists</li>\n<li>count</li>\n<li>aggregate</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">annotate</code> and <code class=\"language-text\">aggregate</code> both expect a expression</p>\n<ul>\n<li>annotate will compute that for each item in the set. Returns each item with new property</li>\n<li>aggregate will return a dictionary with that value for entire set</li>\n<li>Django will create property if not provided</li>\n<li>Tend to be faster than for loops</li>\n</ul>\n</li>\n</ul>\n<!--more-->\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">products <span class=\"token operator\">=</span> products<span class=\"token punctuation\">.</span>annotate<span class=\"token punctuation\">(</span>Count<span class=\"token punctuation\">(</span><span class=\"token string\">'item'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nproducts<span class=\"token punctuation\">.</span>first<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item__count\n\ngrand_total <span class=\"token operator\">=</span> orders<span class=\"token punctuation\">.</span>aggregate<span class=\"token punctuation\">(</span>Sum<span class=\"token punctuation\">(</span><span class=\"token string\">'total'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ngrand_total<span class=\"token punctuation\">[</span><span class=\"token string\">'total__sum'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Unbasis</h2>\n<ul>\n<li><code class=\"language-text\">select_related</code>: Allows getting related objects using single query via JOINs.</li>\n<li><code class=\"language-text\">prefetch_related</code>: Similar to <code class=\"language-text\">select_related</code> will do JOINs in Python</li>\n<li><code class=\"language-text\">defer</code>: Allows to fetch all except specified query</li>\n<li><code class=\"language-text\">only</code>: Allows to fetch selected fields only</li>\n<li><code class=\"language-text\">values</code>: Return dictionaries rather than instances of models</li>\n<li><code class=\"language-text\">values_list</code>: Returns tuples that can be iterated over</li>\n<li><code class=\"language-text\">in_bulk</code>: You pass it list of IDs and returns a dictionary of ID to Model Instance</li>\n<li><code class=\"language-text\">bulk_create</code>: Does the job of creation/insertions in just a single query</li>\n<li>When you access FK relation django issues a DB query</li>\n</ul>\n<h2>Conjunction Dysfunctional</h2>\n<p>When specifying attributes in filter method of QuerySet it generates SQL query with underlying AND construct</p>\n<h2>How to handle OR queries:</h2>\n<ul>\n<li>QuerySet is different from a list. On list you can’t filter on it etc.</li>\n<li>\n<p><code class=\"language-text\">Q</code> E.g. find all users with certain name keywords</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">users <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>\nQ<span class=\"token punctuation\">(</span>first_name__icontains<span class=\"token operator\">=</span><span class=\"token string\">'kelly'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\nQ<span class=\"token punctuation\">(</span>last_name__icontains<span class=\"token operator\">=</span><span class=\"token string\">'kelly'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span>\nQ<span class=\"token punctuation\">(</span>email__icontains<span class=\"token operator\">=</span><span class=\"token string\">'kelly'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>order_by<span class=\"token punctuation\">(</span><span class=\"token string\">'last_name'</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>You can create as complex of an expression as you want with bitwise OR and NOT</li>\n</ul>\n<h2>Query Arithmetic</h2>\n<p><code class=\"language-text\">F</code>, while <code class=\"language-text\">Q</code> represented query contraint. F represents an implicit refrence in DB calls</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">item_sum <span class=\"token operator\">=</span> Sum<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">(</span><span class=\"token string\">'unit_price'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> F<span class=\"token punctuation\">(</span><span class=\"token string\">'quantity'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntotal <span class=\"token operator\">=</span> items<span class=\"token punctuation\">.</span>aggregate<span class=\"token punctuation\">(</span>amount<span class=\"token operator\">=</span>item_sum<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'amount'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2><code class=\"language-text\">F</code> expressions</h2>\n<p>They are examples of Django’s <strong>Query Expressions</strong>. This includes:</p>\n<ul>\n<li>Avg</li>\n<li>Count</li>\n<li>Max</li>\n<li>StdDev</li>\n<li>Sum</li>\n<li>Variance</li>\n<li>Coalesce</li>\n<li>Concat</li>\n<li>Greatest</li>\n<li>Least</li>\n<li>Length</li>\n<li>Lower</li>\n<li>Now</li>\n<li>Substr</li>\n<li>Upper</li>\n</ul>\n<h2>Query expressions also include:</h2>\n<ul>\n<li>F</li>\n<li>Aggregate</li>\n<li>Func</li>\n<li>Value</li>\n<li>ExpressionWrapper</li>\n<li>Conditional</li>\n</ul>\n<h2>Writing custom query expressions, you have to define following methods:</h2>\n<ul>\n<li>as_sql</li>\n<li>as_<vendorname></li>\n<li>get_lookup</li>\n<li>get_transform</li>\n<li>output_field</li>\n</ul>\n<h2>Writing RAW SQLs</h2>\n<p>If you’re writing RAW SQL you should probably rethink what you’re about to do</p>\n<ul>\n<li>\n<p>EXTRA</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">Order<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>extra<span class=\"token punctuation\">(</span>\nselect<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"is_recent\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ordered_at > 2016-01-01\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>Other options</p>\n<ul>\n<li>select</li>\n<li>where</li>\n<li>tables</li>\n<li>order_by</li>\n<li>select_params</li>\n<li>params</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">Order<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>raw<span class=\"token punctuation\">(</span><span class=\"token triple-quoted-string string\">\"\"\"\n  SELECT * FROM ...\n\"\"\"</span><span class=\"token punctuation\">)</span></code></pre></div>","frontmatter":{"layout":"post","title":"Summary: Django - I did not know Queryset could do that","path":"/summary-django-i-didnt-know-queryset-could-do-that/","category":"Technical","tags":["Summary","Python","Django"],"description":"Queryset are commonly used with Django's ORM. I Didn't Know Querysets Could do That by Charlie Guo is a nice Django Con US 2016 talk that delves deeper into useage of QuerySet.  Following is summary notes of the talk","date":"2018/01/29","image":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsSAAALEgHS3X78AAAEL0lEQVQ4y3VUe0xbZRS/pTzGMzHbioM9Oky0bIomWyYxupnMv6aOZAHnZCDR/eHUxGhITJbIfCwal6CEScJrPDqQBNx4tKD0ARdoS9sV6L0X1se97S19twNkhGdLe/xuB4aw7UtOzvlOfvd3v/P9zvkw7CkLAJ6Wxv4NWhQejxOsjD20vLIKa2tr558A/XxnQl5e2az44qfqoe/q/hroJOYyd5DG8fn8I8gfRHbMMKknSJIAiUQSNpvN0CoWX0P5fQKB4CjyKTFCj8cBJosVaJsNGYt44OA24f6sI6lJyckiUf7ZBJTaO2O2akwmEwwPKdcsiFCpUFzlsMdezstMSNpz9DGhm95UKhVhHMejLGtfvV5RcXpHATxkgu0NQc3o5xeXwOHyAsM6gZoxFXF52ZtY3P84p9e/ed9g2FSpVFGGYVbKyso40P5fNbA379wnZwSiExfOVzS/UPJbT3o7Tn3ZhlO3xUPErSbZRG19v+Hk+zemsnLfufiWQHSy8EoDLsQcLAsMTQNttQJBEFGJRJqLCNM7ZNbu5t4RqGrqWK/rHIAereXS7vu/O+bLEvcbH9W090QrG9ojLRJ8HeseM2qlOpOuTzNj6BqeGLlafk2EsAcW58yDHrcDSJIKr6wsg8/nK4mVbWYS9SQVz8XL88acoM+0TlEzgKqLzs/NISWLRlMx7I00DHspDStuS0l/5XQiwuZPUYSOpCiQ9PWFOEX9wYfFHInN4eTb3R7ubrHgQlDIOh2rSqUSZDJZhKbpKFZzzzj7S2OX8/vqZk9lm5T5x7IYU9njD/QzDA3jGvWqDflAIPARl1fqyIT2AZzPxYGFRaHT7V6anDBE9DptyMHaQ1jAxyC1HoDdMQtenz+C2iUbYXNkStwSWHgEzKwbrEhRXKX9dPcdUiQpnDYz4PI/BJp1gXHaDJjTZY+glokoFHJApa2VlpZeRNjc1jHrpere8d9/aOqtuY1bKurkxPGzX8szz33zx6snPvzq+JnPbohu9lPZdzT2coS7eb2huxbhvsWcHl9Yr9OFxkZHI0jplaqqqvxdB3l+OxBLKXkLUv5Wa+dqPVK+T2cpeALHxkoNgNcfhCmChODcwqGtSeG//V5RWtbhozkoRiKQcfP+adzltKH2IjeXlpbA63F/wGEvX/n8uczsw8LYuHbgZFvHCNn+57CxQyw3tLQO6vbt+GtKfHz8oe2NN+CTGwkCpFJpiBvBjY2N2AkLCwv3ICfEnrWKL5dsh4lxcXF5GI93AMWvaXT6BywaBO24JozGFGpra3/kZhytF5HPjn1hVCt5Ft0wb1ot540P9vDwUVUsX1Dw+GXKyMhIQi9OMgpT1ZpxNW2zc10Rvm+YhK679z7mMKdOvZ62NfcY1jBmxxpGtwzFjerZZ76JjSP0361aF9QNmcP1uBWaVey7u7H/ATFHhPOfXrNgAAAAAElFTkSuQmCC","aspectRatio":1.144901610017889,"src":"/blog/static/68c970e59dc437de74928c563897677a/46604/database-schema-1895779_640.png","srcSet":"/blog/static/68c970e59dc437de74928c563897677a/62d80/database-schema-1895779_640.png 125w,\n/blog/static/68c970e59dc437de74928c563897677a/e1953/database-schema-1895779_640.png 250w,\n/blog/static/68c970e59dc437de74928c563897677a/46604/database-schema-1895779_640.png 500w,\n/blog/static/68c970e59dc437de74928c563897677a/f3dec/database-schema-1895779_640.png 640w","sizes":"(max-width: 500px) 100vw, 500px"}}}}}},"pageContext":{}}}